from qdrant_client import QdrantClient
from qdrant_client.models import Distance, VectorParams, PointStruct, Filter, FieldCondition, MatchValue

# memory_size = number_of_vectors * vector_dimension * 4 bytes * 1.5
# Using 768 dimension vectors as I am using snowflake-arctic-embed:110m embedding model

class VectorClient:
    def __init__(self, url="http://localhost:6333", collection_name="pdpa_collection", vector_size=768, distance=Distance.DOT):
        self.client = QdrantClient(url=url)
        self.collection_name = collection_name
        self.vector_size = vector_size
        self.distance = distance

    def create_collection(self):
        collections = self.client.get_collections().collections
        if any(c.name == self.collection_name for c in collections):
            print(f"Collection '{self.collection_name}' already exists.")
            return
        self.client.create_collection(
            collection_name=self.collection_name,
            vectors_config=VectorParams(size=self.vector_size, distance=self.distance),
        )
        print(f"Collection '{self.collection_name}' created.")

    def upsert(self, points):
        """
        points: list of PointStruct
        """
        operation_info = self.client.upsert(
            collection_name=self.collection_name,
            wait=True,
            points=points,
        )
        return operation_info

    def search(self, query_vector, city=None, limit=1):
        must_conditions = []
        if city:
            must_conditions.append(
                FieldCondition(
                    key="city",
                    match=MatchValue(value=city)
                )
            )
        query_filter = Filter(must=must_conditions) if must_conditions else None
        results = self.client.search(
            collection_name=self.collection_name,
            query_vector=query_vector,
            query_filter=query_filter,
            with_payload=True,
            limit=limit,
        )
        return results

if __name__ == "__main__":
    vector_client = VectorClient()
    vector_client.create_collection()
    # points = [
    #     PointStruct(id=1, vector=[0.05, 0.61, 0.76, 0.74], payload={"city": "Berlin"}),
    # ]
    # operation_info = vector_client.upsert(points)
    # print(operation_info)
    search_result = vector_client.search(
        [-0.042982336, 0.055017456, 0.008616467, 0.008941679, 0.047700677, 0.014067338, -0.0321275, -0.040685028, -0.014636617, 0.015488532, -0.02491377, -0.02465737, -0.05884102, -0.037664965, 0.017495466, -0.009800701, 0.006540761, -0.015330429, 0.013904042, -0.038691908, -0.064813174, -0.022315253, 0.0037833434, -0.017966269, -0.03330889, -0.00585501, 0.04307997, 0.030188058, -0.062182933, -0.08707596, 0.018082986, 0.0059904433, 9.988238e-05, -0.024789777, 0.009872354, 0.023839276, -0.012957853, 0.0022211734, -0.055386182, 0.03729001, -0.012687664, -0.0060265725, 0.010865234, 0.010673955, -0.047358986, 0.030964432, -0.04235964, -0.015255351, -0.03937699, -0.048932318, -0.005794583, 0.08406873, -0.015762152, 0.06027273, -0.005151927, 0.029810729, 0.009787086, -0.078740016, -0.008989477, -0.07708809, 0.07821746, -0.012248684, 0.052673984, 0.025935985, 0.04122615, 0.025264604, 0.01687059, -0.02271984, -0.03908392, -0.06714163, -0.080122344, 0.013073266, -0.034398116, 0.010355396, -0.0038002182, -0.0523828, 0.0216639, 0.03611738, -0.008716927, 0.073176265, -0.004870917, -0.016889468, 0.031155184, 0.009607476, -0.02637488, -0.049386695, -0.019159485, -0.019446336, -0.003619629, 0.074734434, -0.010649184, -0.03718643, 0.01468618, -0.017812198, 0.012023052, -0.0012252064, 0.025702571, -0.016150879, 0.003172886, 0.010011183, -0.024318602, -0.041171364, 0.003475101, -0.008724949, -0.07468354, -0.026046187, 0.048510592, 0.0032932493, -0.03134808, 0.0876681, -0.018273994, 0.014669349, 0.0033885024, 0.0048709903, 0.022923326, 0.07154132, 0.01293708, 0.019325845, 0.04101318, 0.019535499, 0.040712323, 0.07051679, 0.0054772757, 0.040945634, -0.004656179, 0.011440615, 0.04898715, 0.010109721, -0.02423282, -0.017754298, 0.03173815, 0.07941352, 0.056489266, -0.044760186, 0.018656291, -0.03368252, -0.0026664326, -0.040809944, 0.029256102, -0.047636822, 0.02932216, 0.042334355, 0.02062419, -0.060352664, 0.022436552, 0.016370708, 0.021804892, 0.037043788, -0.03434327, 0.02052378, 0.01608348, 0.038589556, 0.014810507, -0.04917723, 0.021409424, 0.036927897, 0.014768621, -0.033829693, -0.039190758, 0.011831669, -0.0039787767, -0.04284602, 0.0020621598, 0.021911817, -0.026601503, -0.0349953, -0.009573806, 0.010314769, 0.02572964, 0.017100696, -0.032117426, -0.03737023, 0.026494851, -0.05022657, 0.0686706, 0.013054183, -0.014366696, -0.017380489, -0.027423529, 0.010123678, -0.020903751, 0.06368853, -0.004177464, 0.021516833, -0.006609843, -0.011144409, 0.05712882, -0.07430137, 0.0006967169, 0.01001499, -0.018313654, -0.06680401, 0.0072958744, -0.014737365, 0.011175374, 0.009642508, 0.0060084527, -0.007562018, -0.021883685, 0.07981842, 0.036086507, 0.029433431, 0.040747914, -0.055209037, -0.00377124, 0.019664792, -0.028305147, 0.015673222, -0.008211887, 0.12764795, 0.011620301, -0.028399417, 0.015973547, 0.016377129, -0.023477469, 0.021944186, 0.009669497, -0.06824614, 0.000481378, -0.03408209, 0.03140568, -0.051246665, 0.007374076, 0.05273864, 0.013427056, 0.019151777, 0.025923567, -0.03058341, 0.06158074, 0.04683379, 0.032930672, 0.02713352, -0.0009645386, -0.052892145, -0.004920348, -0.0015702319, 0.007969712, -0.014324578, 0.05591053, -0.03426943, 0.020911366, 0.051979575, 0.03617579, -0.024506262, -0.03584398, 0.028516982, 0.028389296, -0.03254033, 0.027280202, -0.013732436, -0.021975206, -0.043646622, -0.03924464, -0.044777527, 0.07451478, -0.020860748, 0.025583245, 0.004651991, 0.0380015, -0.021021921, -0.079402305, 0.041718766, -0.0054770983, -0.03423003, -0.04814917, -0.03105304, -0.008402706, -0.038454738, -0.010507583, 0.015996585, 0.009814953, 0.012874116, -0.037316207, -0.018423207, -0.03219976, -0.086457476, 0.007936769, 0.056389082, -0.08793263, -0.0032046943, 0.012386943, -0.013695636, 0.0055567115, 0.011447416, 0.043090142, -0.029769816, 0.03759515, -0.06821855, 0.026540577, 0.030762501, -0.0042960807, 0.06477726, -0.06955187, -0.011385026, 0.02882137, -0.0093106115, -0.014426283, 0.003438953, -0.02247446, -0.028780634, 0.026947418, -0.008900554, 0.007037358, -0.008919791, -0.044420242, -0.0018051476, 0.009428471, -0.051526107, 0.0036278074, 0.09790717, 0.0006461266, -0.011154239, 0.016805314, 0.03439382, 0.081895985, -0.011842865, -0.021465294, -0.021537669, -0.005351792, 0.016478507, 0.009090737, 0.02935016, 0.026379285, -0.030409254, 0.0009426262, -0.04882262, -0.030416826, 0.03754966, 0.017369242, -0.047184024, -0.003568699, -0.03221488, -0.009957278, 0.011233247, 0.026690567, -0.02746467, -0.0469743, -0.053698994, -0.055151, 0.0059314645, -0.08076809, 0.023279695, -0.015957162, -0.03618982, -0.026825624, 0.031289212, -0.048911057, 0.007259535, -0.04150719, 0.040183984, 0.005560349, 0.00062857335, -0.008171372, 0.008372044, -0.055078566, -0.0841042, 0.00081576424, 0.05505008, 0.019454997, 0.075672515, -0.0076492587, 0.016061341, -0.013624014, -0.00461006, -0.028984625, -0.0063576307, -0.03299989, 0.0028564578, 0.053489022, -0.021402333, -0.016030164, -0.0215689, 0.021314157, 0.01006674, -0.024303991, -0.08548128, 0.036944333, 0.04700388, -0.030173253, -0.010550327, -0.0025624242, -0.06391079, 0.005808483, 0.016291667, 0.017408932, -0.019994037, 0.031006832, 0.0052703805, -0.028060243, 0.014235138, 0.03855553, 0.056091018, -0.017898181, -0.0078465175, 0.009136452, 0.0064980877, -0.021683648, 0.019442216, 0.060027983, -0.011363307, 0.046178423, 0.0037132706, -0.014136862, 0.033042125, 0.0025584758, 0.056166653, -0.019897373, -0.06461398, 0.034018304, -0.10703493, -0.053787123, -0.01958773, 0.02923503, 0.031447772, -0.10427023, 0.0016918374, -0.000168072, 0.0016135848, 0.037532344, -0.008130944, 0.02037027, -0.035243474, -0.004357452, 0.00043414932, -0.020088471, 0.044041116, 0.05367384, 0.022981303, -0.035459977, 0.013450291, -0.039306093, 0.0227153, 0.0021015666, -0.029560814, -0.030070249, -0.03713393, -0.01766424, -0.012156055, -4.6823564e-07, -0.028295621, -0.013281591, -0.023374602, 0.026179994, -0.0013953606, -0.022986561, 0.007950654, 0.061232712, -0.019490346, 0.022583699, 0.008956365, 0.04173888, -0.013922026, 0.027560579, -0.0028355937, -0.049611665, 0.05083954, 0.008848201, -0.016324146, 0.0034984697, -0.054613568, 0.024439538, -0.018930614, -0.0152557045, -0.048207246, 0.06841326, 0.016927555, 0.008031015, 0.0053361165, 0.041456085, -0.014567982, -0.026940953, -0.014181592, 0.039549753, 0.020953612, -0.036128197, 0.019460639, 0.019148653, 0.02131136, -0.00011939573, -0.03216917, 0.0074406755, 0.016575854, -0.010925411, 0.0024360071, -0.022002928, 0.055949703, 0.03484836, 0.030209003, 0.039133444, -0.018937549, -0.058674805, 0.054846227, 0.019611489, -0.02841858, 0.02185011, -0.067918934, -0.0579426, 0.029389625, 0.06143971, 0.0029018156, 0.00015371952, -0.03691805, 0.029824173, 0.005215682, 0.008327547, 0.0077646333, 0.055777285, -0.066271044, -0.030698454, 0.006496856, -0.046833456, 0.020098418, -0.021694614, -0.09836939, -0.028083846, -0.065478206, -0.06117976, -0.013332832, -0.028460866, -0.027760893, -0.03952326, -0.012095891, -0.031038364, 0.017767655, 0.0029185095, -0.008969005, -0.019844072, -0.016490875, -0.012700049, -0.016669732, -0.023851642, 0.00089732785, -0.001767371, 0.045582693, -0.05442734, 0.008946395, 0.013582415, -0.003190305, 0.016790716, 0.0232938, -0.024778336, -0.013195012, 0.07173695, -0.0121009555, -0.028777001, 0.047829658, -0.025683988, -0.0086679235, -0.008806074, 0.03767368, 0.013548002, -0.056656234, -0.029932665, -0.0054394435, 0.02776591, 0.027876506, 0.023530316, 0.012600221, -0.08353097, -0.0604624, -0.0473865, -0.031020675, 0.063253514, -0.018815136, 0.002559811, -0.053888254, -0.023066983, -0.01160218, -0.0058131884, 0.08402698, 0.043856766, 0.016387993, 0.011391286, 0.018769635, -0.04056354, -0.037006628, 0.033143144, -0.030553212, -0.015687572, 0.01695163, 0.044299956, 0.005013604, -0.00023836618, 0.023570113, 0.008957483, 0.016173625, -0.0029979416, -0.017652389, 0.020553889, 0.06281689, -0.044108115, 0.02593202, -0.0070010447, -0.05145386, -0.023717007, 0.0062635345, -0.062114082, -0.012509945, 3.3358676e-05, 0.07140245, -0.020125378, -0.059405353, 0.023905007, 0.010659835, 0.053266566, 0.011215396, -0.04177431, 0.0090280445, 0.008550798, 0.055677097, 0.0757456, 0.023502499, -0.059885994, -0.016446438, -0.071655884, -0.034964822, 0.035546225, 0.0035041752, 0.02623524, -0.055618394, 0.046943367, 0.011578573, -0.12817232, -0.014834534, 0.06283418, -0.04717432, -0.04123904, -0.022893928, 0.01147193, -0.04014934, 0.08041786, 0.056716684, 0.06831525, 0.003503334, -0.010541829, 0.033030514, 0.0096775815, 0.018518982, 0.05522546, 0.035965577, 0.05332487, 0.042929422, 0.022331186, -0.0038017596, 0.04390367, -0.019838698, -0.027209865, -0.03112629, 0.04191655, 0.06112629, -0.038287934, 0.0026036778, -0.02480784, 0.053054206, 0.0044428534, -0.025613734, -0.019262295, -0.020392336, -0.03897183, 0.0029092168, -0.018254954, 0.030179933, 0.03881109, 0.00017101559, 0.016866919, -0.025759818, 0.011905954, 0.023145651, -0.0008944018, 0.012037493, 0.058284715, 0.01259247, -0.06100306, -0.02464982, 0.019842587, -0.048250396, 0.029169016, 0.052606177, 0.05183398, 0.07341657, 0.0003728227, 0.06979679, -0.017520372, -0.030898605, 0.025937509, -0.034930512, 0.022840356, 0.026783178, 0.020312743, -0.02513785, 0.025379103, -0.013727797, 0.04395807, -0.024381144, 0.002601473, 0.08127789, -0.026892792, 0.00056715537, -0.01769379, -0.03569948, 0.06728411, 0.019988365, -0.026035288, -0.0376238, 0.0058672302, -0.013781645, 0.0914114, -0.03690282, 0.059103172, 0.014605226, 0.004236476, -0.016433688, 0.02713515, 0.052960742, -0.07735105, 0.022428015, 0.00928842, -0.010712357, 0.07004448, -0.0064196936, -0.015402139, -0.004275461, -0.03517307, 0.009680603, 0.049261916, -0.009264151, 0.05801916, -0.05847139, 0.003908786, -0.06078646, 0.029875029, 0.045813464, -0.007361618, -0.0019511877, 0.028777344, 0.049739156, -0.02272183, -0.010263657, -0.0008162832, -0.024575585, 0.051957767, 0.018349051, 0.02963251, -0.0077575985, -0.02622218, 0.05892416, -0.011657191, -0.058216467, -0.03396318, -0.034414142, 0.055523537, -0.022020953, 0.029694352, -0.0190297, 0.025217555, -0.016665915, -0.041973714, -0.019762887, 0.020234022, -0.005038963, -0.04254003, -0.0037198719, 0.06558641, 0.010693984, -0.0013574308, -0.0118462965, 0.0376194, 0.04593949]
        , limit=1)
    print(search_result)